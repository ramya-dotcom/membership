<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNBSP - Create Membership</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #e3f2fd;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background-color: #1565c0;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .progress-bar {
            background-color: #f5f5f5;
            height: 8px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            background-color: #1565c0;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .content {
            padding: 40px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .step-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1565c0;
        }

        .epic-container {
            text-align: center;
            padding: 40px 20px;
        }

        .epic-input {
            max-width: 400px;
            margin: 0 auto 30px;
        }

        .epic-display {
            background-color: #e3f2fd;
            border: 2px solid #1565c0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .epic-display h3 {
            color: #1565c0;
            margin-bottom: 10px;
        }

        .epic-display .epic-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #0d47a1;
            letter-spacing: 2px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn {
            background-color: #1565c0;
            color: white;
            border: none;
            padding: 14px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 10px 5px;
        }

        .btn:hover {
            background-color: #0d47a1;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #757575;
        }

        .btn-secondary:hover {
            background-color: #616161;
        }

        .verification-info {
            background-color: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .verification-info h3 {
            color: #e65100;
            margin-bottom: 10px;
        }

        .verification-info ol {
            margin-left: 20px;
        }

        .verification-info li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .upload-area:hover {
            border-color: #1565c0;
        }

        .upload-area.dragover {
            border-color: #1565c0;
            background-color: #e3f2fd;
        }

        .upload-preview {
            margin-top: 20px;
            text-align: center;
        }

        .upload-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1565c0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background-color: #e8f5e8;
            border: 2px solid #4caf50;
            color: #2e7d32;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .error-message {
            background-color: #ffebee;
            border: 2px solid #f44336;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .inline-error {
            background-color: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 14px;
            display: none;
        }

        .inline-error.show {
            display: block;
        }

        .input-error {
            border-color: #f44336 !important;
            background-color: #ffebee !important;
        }

        .button-group {
            text-align: center;
            margin-top: 30px;
        }

        .receipt {
            background-color: white;
            border: 2px solid #1565c0;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px solid #1565c0;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px dotted #ccc;
        }

        .flow-indicator {
            background-color: #e3f2fd;
            border-left: 4px solid #1565c0;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
            color: #1565c0;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
            }

            .epic-container {
                padding: 20px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>TNBSP Membership Registration</h1>
            <p>Tamil Nadu BSP - Create Your Membership Account</p>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="content">
            <!-- Step 1: EPIC Number Entry + File Upload -->
            <div class="step active" id="step1">
                <div class="step-title">Enter EPIC Number & Upload Verification</div>
                
                <div class="flow-indicator">
                    <strong>Step 1:</strong> Enter your Voter ID (EPIC) Number and upload verification document.
                </div>

                <div class="epic-container">
                    <div class="form-group epic-input">
                        <label for="epicNumber">Voter ID Number (EPIC No.) - Exactly 10 Characters *</label>
                        <input type="text" id="epicNumber" name="voterID" required maxlength="10" 
                               placeholder="Enter 10-character EPIC (e.g., ABC1234567)" 
                               autofocus 
                               style="text-transform: uppercase; letter-spacing: 1px; font-weight: bold;"
                               aria-describedby="epicError epicHelp"
                               autocomplete="off">
                        <small id="epicHelp" style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                            ℹ️ Only uppercase letters (A-Z) and numbers (0-9) allowed. No spaces or special characters.
                        </small>
                        <div id="epicError" class="inline-error" role="alert" aria-live="polite"></div>
                    </div>
                    
                    <div style="margin: 30px 0;">
                        <div class="verification-info">
                            <h3>Verification Instructions:</h3>
                            <ol>
                                <li>Visit <strong><a href="https://electoralsearch.eci.gov.in" target="_blank">https://electoralsearch.eci.gov.in</a></strong></li>
                                <li>Download Document with your Voter ID details and Upload the file below</li>
                            </ol>
                        </div>

                        <div class="form-group">
                            <label for="uploadFile">Upload Voter ID Verification Document *</label>
                            <div class="upload-area" id="uploadArea">
                                <p><strong>Click here to select file</strong> or drag and drop</p>
                                <p>Supported formats: JPG, PNG, PDF (Max size: 5MB)</p>
                                <input type="file" id="uploadFile" accept=".jpg,.jpeg,.png,.pdf" 
                                       style="display: none;" 
                                       aria-describedby="uploadError uploadHelp">
                            </div>
                            <small id="uploadHelp" style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                📁 Accepted formats: JPG, PNG, PDF • Maximum size: 5MB
                            </small>
                            <div id="uploadError" class="inline-error" role="alert" aria-live="polite"></div>
                            <div class="upload-preview" id="uploadPreview"></div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="btn" onclick="verifyDocument()" id="verifyBtn" disabled>Verify Document</button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Document Verification -->
            <div class="step" id="step2">
                <div class="step-title">Document Verification in Progress</div>
                
                <div class="epic-display">
                    <h3>Verifying EPIC Number</h3>
                    <div class="epic-number" id="processingEpicDisplay"></div>
                </div>

                <div class="loading active">
                    <div class="spinner"></div>
                    <h3>Verifying Your Document...</h3>
                    <p>Analyzing your voter ID document against EPIC number.</p>
                    <p style="margin-top: 10px; font-size: 14px; color: #666;">This process typically takes 10-30 seconds.</p>
                </div>
            </div>

            <!-- Step 3: Member Details Form -->
            <div class="step" id="step3">
                <div class="step-title">Complete Your Profile</div>
                
                <div class="flow-indicator">
                    <strong>Step 2:</strong> Document verified successfully! Please complete your profile details.
                </div>

                <div class="success-message">
                    <h3>✓ Document Verification Successful!</h3>
                    <p>Your voter ID document has been verified. Please provide additional details to complete registration.</p>
                </div>

                <div class="epic-display">
                    <h3>Verified EPIC Number</h3>
                    <div class="epic-number" id="finalEpicDisplay"></div>
                </div>

                <form id="memberDetailsForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fullName">Full Name *</label>
                            <input type="text" id="fullName" name="fullName" required placeholder="Enter your full name">
                        </div>
                        <div class="form-group">
                            <label for="profession">Profession *</label>
                            <input type="text" id="profession" name="profession" required placeholder="Enter your profession">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="designation">Designation</label>
                            <input type="text" id="designation" name="designation" placeholder="Enter your designation">
                        </div>
                        <div class="form-group">
                            <label for="mandal">Mandal *</label>
                            <input type="text" id="mandal" name="mandal" required placeholder="Enter your mandal">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dob">Date of Birth *</label>
                            <input type="date" id="dob" name="dob" required>
                        </div>
                        <div class="form-group">
                            <label for="bloodGroup">Blood Group</label>
                            <select id="bloodGroup" name="bloodGroup">
                                <option value="">Select Blood Group</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="contact">Contact Number *</label>
                            <input type="tel" id="contact" name="contact" required pattern="[0-9]{10}" placeholder="Enter 10-digit mobile number">
                        </div>
                        <div class="form-group">
                            <label for="photoUpload">Upload Photo *</label>
                            <input type="file" id="photoUpload" accept="image/*" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="address">Complete Address *</label>
                        <textarea id="address" name="address" required rows="3" placeholder="Enter your complete address with pin code"></textarea>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn">Submit Details</button>
                    </div>
                </form>
            </div>

            <!-- Step 4: Success & Receipt -->
            <div class="step" id="step4">
                <div class="step-title">Registration Complete!</div>
                
                <div class="success-message">
                    <h3>🎉 Welcome to TNBSP!</h3>
                    <p>Your membership has been created successfully.</p>
                </div>

                <div class="receipt">
                    <div class="receipt-header">
                        <h2>TNBSP MEMBERSHIP RECEIPT</h2>
                        <p>Member ID: <span id="memberIdDisplay"></span></p>
                        <p>Membership No: <span id="membershipNoDisplay"></span></p>
                        <p>Date: <span id="receiptDate"></span></p>
                    </div>
                    
                    <div id="receiptDetails"></div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn" onclick="generateCard()">Generate Membership Card</button>
                    <button type="button" class="btn btn-secondary" onclick="goToHome()">Back to Home</button>
                </div>
            </div>

            <!-- Error Step -->
            <div class="step" id="errorStep">
                <div class="step-title">Verification Failed</div>
                
                <div class="error-message">
                    <h3>❌ Document Verification Failed</h3>
                    <p id="errorMessage">Our system could not verify your voter ID document. Please ensure the document clearly shows your voter information.</p>
                </div>

                <div class="button-group">
                    <button type="button" class="btn" onclick="goToStep(1)">Try Again</button>
                    <button type="button" class="btn btn-secondary" onclick="contactSupport()">Contact Support</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8000'; // Change this to your FastAPI server URL
        
        // Global variables
        let currentStep = 1;
        let userData = {};
        let uploadedFile = null;
        let photoFile = null;
        let verificationToken = '';
        let memberData = {};

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            updateProgressBar();
            setupEventListeners();
        });

        function setupEventListeners() {
            // EPIC input validation
            const epicInput = document.getElementById('epicNumber');
            epicInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^A-Z0-9]/g, '').toUpperCase();
                if (value.length > 10) {
                    value = value.substring(0, 10);
                }
                e.target.value = value;
                checkStep1Validity();
            });

            // File upload setup
            setupFileUpload();

            // Member details form
            const memberForm = document.getElementById('memberDetailsForm');
            memberForm.addEventListener('submit', handleMemberSubmission);

            // Photo upload
            const photoUpload = document.getElementById('photoUpload');
            photoUpload.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    photoFile = e.target.files[0];
                }
            });
        }

        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('uploadFile');

            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });

            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        function handleFile(file) {
            if (!validateFile(file)) {
                return;
            }
            
            uploadedFile = file;
            displayFilePreview(file);
            checkStep1Validity();
        }

        function validateFile(file) {
            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];

            if (!allowedTypes.includes(file.type.toLowerCase())) {
                showError('uploadError', 'Invalid file type. Please upload JPG, PNG, or PDF files only.');
                return false;
            }

            if (file.size > maxSize) {
                showError('uploadError', `File too large. Maximum size is 5MB. Your file is ${(file.size / (1024 * 1024)).toFixed(2)}MB.`);
                return false;
            }

            clearError('uploadError');
            return true;
        }

        function displayFilePreview(file) {
            const preview = document.getElementById('uploadPreview');
            preview.innerHTML = '';

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.style.maxWidth = '100%';
                img.style.maxHeight = '200px';
                img.style.borderRadius = '8px';
                img.style.border = '2px solid #1565c0';
                img.onload = function() {
                    URL.revokeObjectURL(img.src);
                };
                preview.appendChild(img);
            }
            
            const fileInfo = document.createElement('div');
            fileInfo.innerHTML = `
                <div style="background-color: #e8f5e8; border: 2px solid #4caf50; border-radius: 8px; padding: 15px; margin-top: 10px;">
                    <p style="margin: 0; color: #2e7d32; font-weight: bold;">✅ File Successfully Uploaded</p>
                    <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                        <strong>File:</strong> ${file.name}<br>
                        <strong>Size:</strong> ${(file.size / 1024).toFixed(1)} KB<br>
                        <strong>Type:</strong> ${file.type}
                    </p>
                </div>
            `;
            preview.appendChild(fileInfo);
        }

        function checkStep1Validity() {
            const epicInput = document.getElementById('epicNumber');
            const verifyBtn = document.getElementById('verifyBtn');
            
            const epicValue = epicInput.value.trim();
            const isEpicValid = epicValue.length === 10 && /^[A-Z0-9]{10}$/.test(epicValue);
            
            if (isEpicValid && uploadedFile) {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify Document';
                verifyBtn.style.backgroundColor = '#1565c0';
            } else {
                verifyBtn.disabled = true;
                verifyBtn.textContent = 'Complete required fields';
                verifyBtn.style.backgroundColor = '#ccc';
            }
        }

        // Step 1: Verify document using FastAPI backend
        async function verifyDocument() {
            const epicNumber = document.getElementById('epicNumber').value.trim();
            
            if (!epicNumber || !uploadedFile) {
                alert('Please enter EPIC number and upload document.');
                return;
            }

            // Store EPIC for display
            document.getElementById('processingEpicDisplay').textContent = epicNumber;
            
            // Move to verification step
            goToStep(2);

            try {
                const formData = new FormData();
                formData.append('epic_number', epicNumber);
                formData.append('pdf_file', uploadedFile);

                const response = await fetch(`${API_BASE_URL}/verify-document/`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    verificationToken = result.verification_token;
                    userData.voterID = epicNumber;
                    
                    // Show success and move to member details
                    setTimeout(() => {
                        document.getElementById('finalEpicDisplay').textContent = epicNumber;
                        goToStep(3);
                    }, 1000);
                } else {
                    // Show error
                    document.getElementById('errorMessage').textContent = result.detail || 'Verification failed. Please check your document.';
                    goToStep('error');
                }
            } catch (error) {
                console.error('Verification error:', error);
                document.getElementById('errorMessage').textContent = 'Network error. Please check your connection and try again.';
                goToStep('error');
            }
        }

        // Step 3: Handle member details submission
        async function handleMemberSubmission(e) {
            e.preventDefault();
            
            if (!verificationToken) {
                alert('Verification token missing. Please start over.');
                goToStep(1);
                return;
            }

            if (!photoFile) {
                alert('Please upload a photo.');
                return;
            }

            const form = e.target;
            const formData = new FormData();
            
            // Add verification token
            formData.append('verification_token', verificationToken);
            
            // Add photo file
            formData.append('photo_file', photoFile);
            
            // Add all form fields
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.name && input.value) {
                    formData.append(input.name, input.value);
                }
            });

            try {
                const response = await fetch(`${API_BASE_URL}/submit-details/`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    memberData = result;
                    
                    // Generate receipt and show success
                    generateReceipt(result);
                    goToStep(4);
                } else {
                    alert(`Error: ${result.detail}`);
                }
            } catch (error) {
                console.error('Submission error:', error);
                alert('Network error. Please try again.');
            }
        }

        // Generate membership card
        async function generateCard() {
            if (!memberData.member_id) {
                alert('Member ID not found. Cannot generate card.');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('member_id', memberData.member_id);

                const response = await fetch(`${API_BASE_URL}/generate-card-pillow/`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (response.ok) {
                    // Download the card
                    const downloadUrl = `${API_BASE_URL}/download-card-pillow?card_path=${encodeURIComponent(result.card_path)}`;
                    window.open(downloadUrl, '_blank');
                } else {
                    alert(`Error generating card: ${result.detail}`);
                }
            } catch (error) {
                console.error('Card generation error:', error);
                alert('Error generating membership card. Please try again.');
            }
        }

        function generateReceipt(data) {
            const now = new Date();
            document.getElementById('memberIdDisplay').textContent = data.member_id;
            document.getElementById('membershipNoDisplay').textContent = data.membership_no;
            document.getElementById('receiptDate').textContent = now.toLocaleDateString();
            
            const receiptDetails = document.getElementById('receiptDetails');
            receiptDetails.innerHTML = `
                <div class="receipt-item"><span>Name:</span><span>${userData.fullName || 'N/A'}</span></div>
                <div class="receipt-item"><span>Voter ID:</span><span>${userData.voterID}</span></div>
                <div class="receipt-item"><span>Contact:</span><span>${userData.contact || 'N/A'}</span></div>
                <div class="receipt-item"><span>Mandal:</span><span>${userData.mandal || 'N/A'}</span></div>
                <div class="receipt-item"><span>Member ID:</span><span>${data.member_id}</span></div>
                <div class="receipt-item"><span>Membership No:</span><span>${data.membership_no}</span></div>
            `;

            // Store form data for receipt
            const form = document.getElementById('memberDetailsForm');
            const formData = new FormData(form);
            for (let [key, value] of formData.entries()) {
                userData[key] = value;
            }
        }

        function goToStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            
            if (step === 'error') {
                document.getElementById('errorStep').classList.add('active');
            } else {
                document.getElementById(`step${step}`).classList.add('active');
                currentStep = step;
                updateProgressBar();
            }
        }

        function updateProgressBar() {
            const progress = (currentStep / 4) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.add('show');
        }

        function clearError(elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.classList.remove('show');
        }

        function goToHome() {
            window.location.href = '/';
        }

        function contactSupport() {
            alert('For support, please contact: support@tnbsp.org or call +91-XXXXXXXXXX');
        }
    </script>
</body>
</html>